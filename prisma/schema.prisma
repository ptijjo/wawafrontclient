// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

enum ServiceType {
  TRESSES
  TATTOUAGE
  CILS
  SOINS_DE_LA_PEAU
}

// Exemple de modèle
model User {
  id                     String    @id @default(cuid())
  email                  String    @unique
  password               String
  firstname              String
  lastname               String
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  failedLoginAttempts    Int       @default(0)
  lockedUntil            DateTime?
  desactivateAccountDate DateTime?

  //Relations
  loginHistories loginHistory[]
  sessions       Session?
}

model LoginAttempt {
  id        String   @id @default(cuid())
  email     String
  ipAddress String
  userAgent String
  timestamp DateTime @default(now())
  success   Boolean
}

model loginHistory {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String
  userAgent String
  timestamp DateTime @default(now())
}

model Session {
  id        String    @id @default(cuid())
  userId    String    @unique
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent String
  ipAddress String
  jti       String    @unique // identifiant unique du refresh token (JWT ID)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime
  isRevoked Boolean   @default(false)
  revokedAt DateTime?
}

//
// SERVICES PROPOSÉS PAR LE SALON
// (ex : Tresses, Tatouage, Pose de cils ...)
//
model Service {
  id          String      @id @default(cuid())
  service     ServiceType
  durationMin Int // durée du service en minutes (30, 45, 60…)
  price       Int?
  description String?

  appointments Appointment[]
}

//
// DISPONIBILITÉS DU SALON
// Chaque créneau défini par l'admin
//
model Availability {
  id            String       @id @default(cuid())
  date          DateTime // date du créneau disponible
  isBooked      Boolean      @default(false)
  isBlocked     Boolean      @default(false) // true si bloqué pour vacances/indisponibilité
  blockedNote   String? // raison du blocage (vacances, événement, etc.)
  createdAt     DateTime     @default(now())
  appointmentId String?
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)
}

//
// RENDEZ-VOUS PRIS PAR LES CLIENTS
//

model Appointment {
  id        String  @id @default(cuid())
  lastname  String // nom du client
  firstname String // prénom du client
  phone     String // téléphone
  email     String? // facultatif
  note      String? // optionnel, pour un message client

  serviceId String
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Multi-slots: un rendez-vous occupe plusieurs Availability
  availabilities Availability[]

  createdAt DateTime @default(now())
}
