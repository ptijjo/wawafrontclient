// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "mongodb"
  url      = env("DATABASE_URL")
}

enum ServiceType {
  COIFFURE
  TATTOUAGE
  PIERCING
  CILS
}

// Exemple de modèle
model User {
  id                     String    @id @default(auto()) @map("_id") @db.ObjectId
  email                  String    @unique
  password               String
  firstname              String
  lastname               String
  createdAt              DateTime  @default(now())
  updatedAt              DateTime  @updatedAt
  failedLoginAttempts    Int       @default(0)
  lockedUntil            DateTime?
  desactivateAccountDate DateTime?

  //Relations
  loginHistories loginHistory[]
  sessions       Session?

  @@index([email])
  @@index([lockedUntil])
}

model LoginAttempt {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  email     String
  ipAddress String
  userAgent String
  timestamp DateTime @default(now())
  success   Boolean

  @@index([email, timestamp])
  @@index([ipAddress, timestamp])
}

model loginHistory {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  userId    String   @db.ObjectId
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ipAddress String
  userAgent String
  timestamp DateTime @default(now())

  @@index([userId, timestamp])
}

model Session {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  userId    String    @unique @db.ObjectId
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userAgent String
  ipAddress String
  jti       String    @unique // identifiant unique du refresh token (JWT ID)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  expiresAt DateTime
  isRevoked Boolean   @default(false)
  revokedAt DateTime?

  @@index([jti])
  @@index([expiresAt])
  @@index([isRevoked, expiresAt])
}

//
// SERVICES PROPOSÉS PAR LE SALON
// (ex : Tresses, Tatouage, Pose de cils ...)
//
model Service {
  id          String      @id @default(auto()) @map("_id") @db.ObjectId
  service     ServiceType
  durationMin Int // durée du service en minutes (30, 45, 60…)
  price       Int?
  description String?

  appointments Appointment[]
}

//
// DISPONIBILITÉS DU SALON
// Chaque créneau défini par l'admin
//
model Availability {
  id            String       @id @default(auto()) @map("_id") @db.ObjectId
  date          DateTime // date du créneau disponible
  isBooked      Boolean      @default(false)
  isBlocked     Boolean      @default(false) // true si bloqué pour vacances/indisponibilité
  blockedNote   String? // raison du blocage (vacances, événement, etc.)
  createdAt     DateTime     @default(now())
  appointmentId String?      @db.ObjectId
  appointment   Appointment? @relation(fields: [appointmentId], references: [id], onDelete: SetNull)

  @@index([date])
  @@index([isBooked, date])
  @@index([isBlocked, date])
  @@index([appointmentId])
  @@index([date, isBooked, isBlocked])
}

//
// RENDEZ-VOUS PRIS PAR LES CLIENTS
//

model Appointment {
  id        String  @id @default(auto()) @map("_id") @db.ObjectId
  lastname  String // nom du client
  firstname String // prénom du client
  phone     String // téléphone
  email     String? // facultatif
  note      String? // optionnel, pour un message client

  serviceId String  @db.ObjectId
  service   Service @relation(fields: [serviceId], references: [id], onDelete: Cascade)

  // Multi-slots: un rendez-vous occupe plusieurs Availability
  availabilities Availability[]

  createdAt DateTime @default(now())

  @@index([serviceId])
  @@index([createdAt])
  @@index([email])
  @@index([phone])
}
